<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Links - v5 (Drag/Sort/Search)</title>

<!-- SheetJS for import/export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --primary:#1b75bb; --primary-dark:#0f5c94; --bg:#f4f8fc;
    --card:#fff; --border:#dbe7f3; --text:#1b2e3c; --muted:#6e7c87;
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,Segoe UI,Arial;margin:0;padding:30px;background:var(--bg);color:var(--text)}
  header{max-width:1150px;margin:0 auto 18px;display:flex;justify-content:space-between;align-items:center;gap:12px}
  .left-controls{display:flex;gap:10px;align-items:center}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
  .title{font-weight:700}
  .controls{display:flex;gap:8px;align-items:center}
  button{padding:9px 12px;border-radius:10px;border:1px solid var(--border);cursor:pointer;background:#fff;color:var(--primary-dark);font-weight:600}
  .btn-primary{background:var(--primary);color:#fff;border:0}
  .btn-danger{background:#c0392b;color:#fff;border:0}
  .small{padding:7px 9px;font-size:14px}
  input.search{padding:9px 12px;border-radius:10px;border:1px solid var(--border);width:240px}
  select{padding:9px;border-radius:10px;border:1px solid var(--border)}
  main{max-width:1150px;margin:0 auto}
  .category-row{margin-top:18px;padding:10px;border-radius:12px;background:transparent;transition:background .12s; border:0}
  .category-row.drag-over{background:rgba(27,117,187,0.04)}
  .category-header{display:flex;gap:12px;align-items:center}
  .cat-icon{width:46px;height:46px;border-radius:10px;background:#eaf3fc;display:flex;align-items:center;justify-content:center;font-size:20px}
  .cat-title{font-size:18px;font-weight:700}
  .muted{font-size:13px;color:var(--muted)}
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(235px,1fr));gap:12px;margin-top:12px;padding:6px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;min-height:86px;box-shadow:0 4px 12px rgba(16,41,66,0.04);cursor:grab;display:flex;flex-direction:column;gap:6px;user-select:none}
  .card.dragging{opacity:0.6}
  .card:hover{transform:translateY(-4px)}
  .card-title{font-weight:700}
  .card-url{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .add-card{display:flex;align-items:center;justify-content:center;font-size:30px;background:#eef5ff;border:2px dashed var(--primary);min-height:86px;border-radius:12px;cursor:pointer}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:999}
  .modal{background:#fff;padding:16px;border-radius:12px;width:420px;max-width:100%}
  input,select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);margin-top:8px}
  .row{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
  .hint{font-size:13px;color:var(--muted);margin-top:6px}
  @media(max-width:640px){.cards{grid-template-columns:repeat(auto-fill,minmax(160px,1fr));}.search{width:140px}}
</style>
</head>
<body>

<header>
  <div class="left-controls">
    <div class="brand">
      <div class="logo">DL</div>
      <div>
        <div class="title">Dashboard Links â€” v5</div>
        <div class="muted">Light Professional UI</div>
      </div>
    </div>

    <input class="search" id="searchBox" placeholder="Search links by title..." />
    <label class="muted" style="font-size:13px">Sort:</label>
    <select id="catSort">
      <option value="default">Default order</option>
      <option value="alpha">Alphabetical A â†’ Z</option>
      <option value="alpha-desc">Alphabetical Z â†’ A</option>
      <option value="most">Most links â†’ Least</option>
      <option value="least">Least â†’ Most</option>
    </select>
  </div>

  <div class="controls">
    <button id="btnAddCategory">+ Add Category</button>
    <button class="btn-primary" id="btnAddLink">+ Add Link</button>
    <button id="btnDelete">ðŸ—‘ Delete</button>
    <button id="btnExport">ðŸ“¤ Export</button>
    <button id="btnImport">ðŸ“¥ Import</button>
  </div>
</header>

<main id="mainArea"></main>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop"><div class="modal" id="modalContent"></div></div>

<script>
/* ===== STORAGE KEYS & INITIAL DATA ===== */
const CATS_KEY = "cats_v5";
const LINKS_KEY = "links_v5";

let categories = JSON.parse(localStorage.getItem(CATS_KEY)) || [
  {id:"c1",name:"HR"},
  {id:"c2",name:"Production"},
  {id:"c3",name:"Finance"},
  {id:"c4",name:"IT"},
  {id:"c5",name:"Admin"}
];
let links = JSON.parse(localStorage.getItem(LINKS_KEY)) || [];

/* Save helper */
const saveAll = ()=>{ localStorage.setItem(CATS_KEY, JSON.stringify(categories)); localStorage.setItem(LINKS_KEY, JSON.stringify(links)); };

/* Icon helper */
const getIcon = (cat)=> ({HR:"ðŸ‘¨â€ðŸ’¼",Production:"ðŸ­",Finance:"ðŸ’°",IT:"ðŸ’»",Admin:"ðŸ¢"}[cat] || "ðŸ”—");

/* UID */
const uid = ()=> "id"+Math.random().toString(36).slice(2,9);

/* ===== RENDER WITH FILTER/SORT ===== */
const mainArea = document.getElementById("mainArea");
const searchBox = document.getElementById("searchBox");
const catSort = document.getElementById("catSort");

function applySort(arr){
  const mode = catSort.value;
  if(mode==="alpha") return [...arr].sort((a,b)=> a.name.localeCompare(b.name));
  if(mode==="alpha-desc") return [...arr].sort((a,b)=> b.name.localeCompare(a.name));
  if(mode==="most") return [...arr].sort((a,b)=> links.filter(l=>l.category==b.id).length - links.filter(l=>l.category==a.id).length);
  if(mode==="least") return [...arr].sort((a,b)=> links.filter(l=>l.category==a.id).length - links.filter(l=>l.category==b.id).length);
  return arr; // default keeps stored order
}

function render(){
  const q = (searchBox.value||"").trim().toLowerCase();
  mainArea.innerHTML = "";

  // categories arranged by chosen sort
  const cats = applySort(categories);

  cats.forEach(cat => {
    const row = document.createElement("div");
    row.className = "category-row";
    row.draggable = true;
    row.dataset.catId = cat.id;

    // header
    const header = document.createElement("div");
    header.className = "category-header";
    header.innerHTML = `<div class="cat-icon">${getIcon(cat.name)}</div>
                        <div>
                          <div class="cat-title">${cat.name}</div>
                          <div class="muted">${links.filter(l=>l.category==cat.id).length} links</div>
                        </div>`;
    row.appendChild(header);

    // cards container (drop target)
    const cards = document.createElement("div");
    cards.className = "cards";
    cards.dataset.catId = cat.id;
    cards.addEventListener("dragover", ev => { ev.preventDefault(); cards.classList.add("drag-over"); });
    cards.addEventListener("dragleave", ev => cards.classList.remove("drag-over"));
    cards.addEventListener("drop", ev => {
      ev.preventDefault();
      cards.classList.remove("drag-over");
      const data = JSON.parse(ev.dataTransfer.getData("text/plain")||null || "{}");
      if(!data || !data.type) return;
      if(data.type==="card"){
        // move card to this category at end
        links = links.filter(l=> l.id !== data.id);
        const newLink = {...data.payload, category: cat.id};
        links.push(newLink);
        saveAll(); render();
      }
      if(data.type==="cat"){
        // reorder categories: drop cat before/after? We place dropped cat before this cat
        const draggedId = data.id;
        if(draggedId === cat.id) return;
        const srcIndex = categories.findIndex(c=>c.id===draggedId);
        const dstIndex = categories.findIndex(c=>c.id===cat.id);
        const [moved] = categories.splice(srcIndex,1);
        categories.splice(dstIndex,0,moved);
        saveAll(); render();
      }
    });

    // add card nodes (filtered by search)
    links.forEach(l=>{
      if(l.category !== cat.id) return;
      if(q && !l.title.toLowerCase().includes(q)) return;
      const c = document.createElement("div");
      c.className = "card";
      c.draggable = true;
      c.dataset.linkId = l.id;
      c.innerHTML = `<div class="card-title">${l.title}</div><div class="card-url">${l.url}</div>`;
      c.addEventListener("click", ()=> window.open(l.url,"_blank"));
      c.addEventListener("dragstart", ev=>{
        c.classList.add("dragging");
        ev.dataTransfer.setData("text/plain", JSON.stringify({type:"card", id: l.id, payload: l}));
        ev.dataTransfer.effectAllowed = "move";
      });
      c.addEventListener("dragend", ev=> c.classList.remove("dragging"));
      cards.appendChild(c);
    });

    // add-card tile
    const add = document.createElement("div");
    add.className = "card add-card";
    add.textContent = "+";
    add.addEventListener("click", ()=> openLinkModal(cat.id));
    cards.appendChild(add);

    row.appendChild(cards);

    // category-level drag handlers for reordering categories
    row.addEventListener("dragstart", ev=>{
      ev.dataTransfer.setData("text/plain", JSON.stringify({type:"cat", id: cat.id}));
      ev.dataTransfer.effectAllowed = "move";
      row.style.opacity = "0.5";
    });
    row.addEventListener("dragend", ev=> row.style.opacity = "1");

    mainArea.appendChild(row);
  });
}

/* ===== MODALS & CRUD ===== */
const backdrop = document.getElementById("modalBackdrop");
const modalC = document.getElementById("modalContent");
const openModal = html => { modalC.innerHTML = html; backdrop.style.display = "flex"; };
const closeModal = ()=> { backdrop.style.display = "none"; modalC.innerHTML = ""; };
backdrop.addEventListener("click", e=> { if(e.target === backdrop) closeModal(); });

/* Add Category */
document.getElementById("btnAddCategory").onclick = ()=> {
  openModal(`<h3>Add Category</h3>
    <input id="catName" placeholder="Category name" />
    <div class="row"><button class="btn btn-primary" id="saveCat">Save</button></div>`);
  document.getElementById("saveCat").onclick = ()=>{
    const name = document.getElementById("catName").value.trim();
    if(!name) return alert("Enter name");
    categories.push({id: uid(), name});
    saveAll(); closeModal(); render();
  };
};

/* Add Link */
function openLinkModal(catId){
  const opts = categories.map(c => `<option value="${c.id}" ${c.id===catId?"selected":""}>${c.name}</option>`).join("");
  openModal(`<h3>Add Link</h3>
    <input id="lTitle" placeholder="Title" />
    <input id="lUrl" placeholder="https://example.com" />
    <select id="lCat">${opts}</select>
    <div class="row"><button class="btn btn-primary" id="saveLink">Save</button></div>`);
  document.getElementById("saveLink").onclick = ()=>{
    const t = document.getElementById("lTitle").value.trim();
    const u = document.getElementById("lUrl").value.trim();
    const c = document.getElementById("lCat").value;
    if(!t||!u) return alert("All fields required");
    links.push({id: uid(), title: t, url: u, category: c});
    saveAll(); closeModal(); render();
  };
}
document.getElementById("btnAddLink").onclick = ()=> openLinkModal(categories[0]?.id || null);

/* Delete menu (top) */
document.getElementById("btnDelete").onclick = ()=> {
  const catOpts = categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join("");
  const linkOpts = links.map(l=>`<option value="${l.id}">${l.title}</option>`).join("");
  openModal(`<h3>Delete</h3>
    <label><input type="radio" name="dType" value="cat" checked> Delete Category</label><br>
    <label><input type="radio" name="dType" value="link"> Delete Link</label>
    <div id="delWrap" style="margin-top:10px;"><select id="delSelect">${catOpts}</select></div>
    <div class="row"><button class="btn-danger" id="doDelete">Delete</button></div>`);
  document.querySelectorAll("input[name='dType']").forEach(r=> r.onchange = ()=>{
    const t = document.querySelector("input[name='dType']:checked').value;
    document.getElementById("delWrap").innerHTML = t === "cat" ? `<select id="delSelect">${catOpts}</select>` : `<select id="delSelect">${linkOpts}</select>`;
  });
  document.getElementById("doDelete").onclick = ()=>{
    const type = document.querySelector("input[name='dType']:checked').value;
    const id = document.getElementById("delSelect").value;
    if(type==="cat"){
      if(links.some(l=>l.category==id)) return alert("Category not empty â€” remove links first");
      categories = categories.filter(c=>c.id!==id);
    } else {
      links = links.filter(l=>l.id!==id);
    }
    saveAll(); closeModal(); render();
  };
};

/* ===== IMPORT / EXPORT ===== */
/* EXPORT -> XLSX (SheetJS) & CSV */
document.getElementById("btnExport").onclick = ()=>{
  const data = links.map(l => ({
    Category: categories.find(c=>c.id===l.category)?.name || "",
    Title: l.title,
    URL: l.url
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Links");
  XLSX.writeFile(wb, "DashboardLinks.xlsx");
};

/* Provide sample of export (CSV preview) on Import click (we show sample) */
document.getElementById("btnImport").onclick = ()=>{
  openModal(`<h3>Import (CSV / XLSX)</h3>
    <div class="hint">Select a CSV/XLSX file with columns: <b>Category, Title, URL</b> (headers required).</div>
    <div style="margin-top:10px;font-family:monospace;background:#f8fafc;padding:10px;border-radius:8px;border:1px solid var(--border);max-height:160px;overflow:auto;">
Category,Title,URL
HR,HR Portal,https://hr.company.local
Finance,Tally,https://tally.company.local
IT,Asset Manager,https://assets.local
    </div>
    <div style="margin-top:10px;">
      <input type="file" id="fileInput" accept=".csv,.xlsx" />
    </div>
    <div class="row"><button class="btn-primary" id="doImport">Import</button></div>
  `);

  document.getElementById("doImport").onclick = ()=> {
    const f = document.getElementById("fileInput").files[0];
    if(!f) return alert("Choose a file first");
    const reader = new FileReader();
    reader.onload = (e)=>{
      const data = e.target.result;
      const wb = XLSX.read(data, {type: "binary"});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws);
      // clear links and merge/create categories as needed
      links = [];
      rows.forEach(r=>{
        const catName = (r.Category||"").toString().trim();
        if(!catName) return;
        let cat = categories.find(c => c.name.toLowerCase()===catName.toLowerCase());
        if(!cat){ cat = {id: uid(), name: catName}; categories.push(cat); }
        links.push({id: uid(), title: (r.Title||"").toString(), url: (r.URL||"").toString(), category: cat.id});
      });
      saveAll(); closeModal(); render(); alert("Import done");
    };
    // read as binary
    reader.readAsBinaryString(f);
  };
};

/* ===== SEARCH + SORT events ===== */
searchBox.addEventListener("input", ()=> render());
catSort.addEventListener("change", ()=> render());

/* initial render */
render();

</script>
</body>
</html>
