<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Links - v9 (Cards)</title>

<!-- SheetJS for import/export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --primary:#1b75bb;
    --accent:#0f5c94;
    --bg1: rgba(235,246,255,0.85);
    --glass-bg: rgba(255,255,255,0.55);
    --card:#ffffff;
    --muted:#6e7c87;
    --radius:14px;
    --shadow: 0 10px 30px rgba(20,40,80,0.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter, "Segoe UI", Roboto, Arial; color:#123;
    background:linear-gradient(180deg,#eef6fb 0%, #f7fbff 100%);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    padding:28px;
    /* subtle background pattern */
    background-image: radial-gradient(circle at 10% 10%, rgba(27,117,187,0.03), transparent 6%), radial-gradient(circle at 90% 80%, rgba(1,97,153,0.03), transparent 8%);
  }

  /* top header */
  header{
    max-width:1200px;margin:0 auto 22px;display:flex;align-items:center;justify-content:space-between;gap:12px;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .logo{
    width:60px;height:60px;border-radius:12px;
    background:linear-gradient(135deg,var(--primary),var(--accent));
    color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px;
    box-shadow: 0 8px 20px rgba(27,117,187,0.15);
  }
  .title{font-size:20px;font-weight:700}
  .subtitle{font-size:13px;color:var(--muted)}

  /* top controls */
  .controls{
    display:flex;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .controls button{
    border:0;background:transparent;padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer;
    box-shadow:none;color:var(--primary);border:1px solid rgba(27,117,187,0.08);
    background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(255,255,255,0.6));
  }
  .btn-primary{background:linear-gradient(90deg,var(--accent),var(--primary));color:#fff;border:none;box-shadow:var(--shadow)}
  .btn-danger{background:#ef6b6b;color:#fff;border:none}
  .status{padding:7px 10px;border-radius:10px;background:rgba(255,255,255,0.6);border:1px solid rgba(0,0,0,0.04);font-size:13px}

  .search-wrap{display:flex;gap:8px;align-items:center}
  input.search{padding:10px 12px;border-radius:10px;border:1px solid rgba(20,30,60,0.06);width:260px}

  /* layout */
  main{max-width:1200px;margin:0 auto}
  /* glass panel for cards area */
  .panel{
    margin-top:18px;padding:18px;border-radius:18px;
    background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.5));
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border:1px solid rgba(255,255,255,0.6);
    box-shadow: 0 12px 40px rgba(16,35,70,0.04);
  }

  /* cards grid - Option A: 3 per row desktop */
  .cards-grid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:16px;
  }
  @media(max-width:1100px){ .cards-grid{grid-template-columns: repeat(2,1fr);} }
  @media(max-width:700px){ .cards-grid{grid-template-columns: 1fr;} }

  .card{
    background:var(--card);border-radius:12px;padding:14px;min-height:120px;
    box-shadow:var(--shadow);position:relative;overflow:hidden;border:1px solid rgba(10,20,40,0.04);
    transition: transform .14s ease, box-shadow .14s ease;
  }
  .card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(20,40,80,0.08)}
  .card-head{display:flex;align-items:center;gap:12px}
  .card-icon{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px}
  .card-title{font-weight:800;font-size:16px}
  .card-sub{font-size:13px;color:var(--muted);margin-top:4px}

  /* expand area */
  .links-area{
    margin-top:12px;border-radius:10px;padding:12px;background:rgba(245,250,255,0.8);border:1px solid rgba(20,50,90,0.04);
    display:none; /* toggled when expanded */
  }
  .links-grid{
    display:grid;grid-template-columns:repeat(3,1fr);gap:12px;
  }
  @media(max-width:900px){ .links-grid{grid-template-columns:repeat(2,1fr);} }
  @media(max-width:520px){ .links-grid{grid-template-columns:1fr;} }

  .link-tile{
    background:white;padding:10px;border-radius:10px;border:1px solid rgba(20,40,80,0.04);
    min-height:64px;display:flex;flex-direction:column;justify-content:center;cursor:pointer;
    box-shadow:0 6px 16px rgba(20,40,80,0.03);
  }
  .link-title{font-weight:700}
  .link-url{font-size:12px;color:var(--muted);margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .tile-actions{display:flex;gap:8px;position:absolute;right:12px;top:12px}
  .small-btn{padding:6px 8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.7);cursor:pointer;font-weight:600;color:var(--primary)}
  .small-danger{background:#fff0f0;border:1px solid rgba(200,50,50,0.12);color:#c0392b}

  .card-footer{margin-top:12px;display:flex;justify-content:space-between;align-items:center}
  .muted{color:var(--muted);font-size:13px}

  /* add card button */
  .add-card{
    display:flex;align-items:center;justify-content:center;border:2px dashed rgba(27,117,187,0.18);background:linear-gradient(180deg,rgba(235,245,255,0.6),rgba(255,255,255,0.45));border-radius:12px;min-height:120px;font-size:34px;color:var(--primary);cursor:pointer;
  }

  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:2000}
  .modal{width:420px;max-width:100%;background:white;padding:18px;border-radius:12px}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(10,20,40,0.06);margin-top:8px}

  /* hint */
  .hint{font-size:13px;color:var(--muted);margin-top:10px}

</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">DL</div>
    <div>
      <div class="title">Dashboard Links â€“ v9</div>
      <div class="subtitle">Cards view (Admin editable) â€¢ Glass UI</div>
    </div>
  </div>

  <div class="controls">
    <div class="search-wrap">
      <input class="search" id="searchBox" placeholder="Search links or cards..." />
    </div>

    <div>
      <button id="btnAddCard" style="display:none">+ Card</button>
      <button id="btnAddLink" class="btn-primary" style="display:none">+ Link</button>
      <button id="btnDelete" style="display:none">Delete</button>
      <button id="btnExport" style="display:none">Export</button>
      <button id="btnImport" style="display:none">Import</button>
      <button id="btnSettings" style="display:none">Settings</button>
      <button id="btnAdminToggle">ðŸ”’ Admin Login</button>
      <span id="adminStatus" class="status" style="display:none;margin-left:8px">Admin</span>
    </div>
  </div>
</header>

<main>
  <div class="panel">
    <div class="cards-grid" id="cardsGrid">
      <!-- cards inserted here -->
    </div>

    <div class="hint">Public view is read-only. Login as admin to manage cards & links.</div>
  </div>
</main>

<!-- MODAL -->
<div class="modal-back" id="modalBackdrop"><div class="modal" id="modalContent"></div></div>

<script>
/* ---------- STORAGE KEYS & DEFAULTS ---------- */
const PIN_KEY = "dashboard_pin_v9";
const SESSION_KEY = "dashboard_admin_session_v9";
const CARDS_KEY = "dashboard_cards_v9"; // cards array: {id,name,icon,links: [{id,title,url}]}
const AUTO_LOCK_MS = 5*60*1000; // 5 minutes

/* init admin PIN (stored in localStorage) */
const DEFAULT_PIN = "123456";
let ADMIN_PIN = localStorage.getItem(PIN_KEY) || DEFAULT_PIN;

/* load cards */
let cards = JSON.parse(localStorage.getItem(CARDS_KEY) || "null");
if(!cards){
  cards = [
    {id:"card1", name:"IT", icon:"ðŸ’»", links:[
      {id:"l1", title:"Asset Management", url:"http://192.168.96.10:92/login.php"},
      {id:"l2", title:"Network Monitor", url:"http://192.168.96.10:5002/"},
      {id:"l3", title:"Gate_IN/OUT", url:"http://192.168.96.11:88/"},
      {id:"l4", title:"Bhiwadi_ERP", url:"http://192.168.11.4/erp/"},
      {id:"l5", title:"Bhiwadi_Dummy_ERP", url:"http://192.168.11.4/dummy/"},
      {id:"l6", title:"Bhiwadi_MRP", url:"http://192.168.11.1/mrp-ebws/"},
      {id:"l7", title:"Bhiwadi_QAS", url:"http://192.168.11.1/qas-ebws/"}
    ]},
    {id:"card2", name:"Finance", icon:"ðŸ’°", links:[]},
    {id:"card3", name:"HR", icon:"ðŸ‘¨â€ðŸ’¼", links:[]}
  ];
  localStorage.setItem(CARDS_KEY, JSON.stringify(cards));
}

/* helpers */
const uid = ()=> "id"+Math.random().toString(36).slice(2,9);
const isAdmin = ()=> sessionStorage.getItem(SESSION_KEY) === "true";
const modalBackdrop = document.getElementById("modalBackdrop");
const modalContent = document.getElementById("modalContent");

function saveAll(){ localStorage.setItem(CARDS_KEY, JSON.stringify(cards)); }

/* UI refs */
const cardsGrid = document.getElementById("cardsGrid");
const searchBox = document.getElementById("searchBox");
const btnAdminToggle = document.getElementById("btnAdminToggle");
const adminStatus = document.getElementById("adminStatus");

/* control buttons */
const ctrlIds = ["btnAddCard","btnAddLink","btnDelete","btnExport","btnImport","btnSettings"];

/* activity timer for auto-lock */
let activityTimer = null;
function resetActivityTimer(){
  if(!isAdmin()) return;
  sessionStorage.setItem("lastActivity", Date.now());
}
function startActivityWatcher(){
  clearInterval(activityTimer);
  activityTimer = setInterval(()=>{
    if(!isAdmin()) return;
    const last = parseInt(sessionStorage.getItem("lastActivity")||0);
    if(Date.now() - last > AUTO_LOCK_MS){
      alert("Session locked due to inactivity (5 minutes). Login again.");
      logoutAdmin();
      render();
    }
  },4000);
  window.addEventListener("mousemove", resetActivityTimer);
  window.addEventListener("keydown", resetActivityTimer);
  window.addEventListener("click", resetActivityTimer);
}
function stopActivityWatcher(){
  clearInterval(activityTimer);
  activityTimer = null;
  window.removeEventListener("mousemove", resetActivityTimer);
  window.removeEventListener("keydown", resetActivityTimer);
  window.removeEventListener("click", resetActivityTimer);
}

/* update admin controls visibility */
function updateAdminControls(){
  const admin = isAdmin();
  ctrlIds.forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;
    el.style.display = admin ? "" : "none";
  });
  adminStatus.style.display = admin ? "" : "none";
  btnAdminToggle.textContent = admin ? "ðŸ”“ Logout" : "ðŸ”’ Admin Login";
}

/* render cards grid */
function render(){
  updateAdminControls();
  const q = (searchBox.value||"").toLowerCase();
  cardsGrid.innerHTML = "";

  // for each card
  cards.forEach(card => {
    // filter card by search (match card name or any link title)
    const matchesCard = card.name.toLowerCase().includes(q) || card.links.some(l => l.title.toLowerCase().includes(q));
    if(q && !matchesCard) return;

    const el = document.createElement("div");
    el.className = "card";
    el.dataset.cardId = card.id;

    // header
    const head = document.createElement("div");
    head.className = "card-head";
    head.innerHTML = `<div class="card-icon">${card.icon||"ðŸ”—"}</div>
                      <div style="flex:1">
                        <div class="card-title">${card.name}</div>
                        <div class="card-sub">${card.links.length} links</div>
                      </div>`;

    // actions (admin: edit card / delete)
    const actions = document.createElement("div");
    actions.className = "tile-actions";
    if(isAdmin()){
      const editBtn = document.createElement("button"); editBtn.className = "small-btn"; editBtn.textContent = "Edit"; editBtn.onclick = (ev)=>{ ev.stopPropagation(); openEditCard(card.id); };
      const delBtn = document.createElement("button"); delBtn.className = "small-btn small-danger"; delBtn.textContent = "Del"; delBtn.onclick = (ev)=>{ ev.stopPropagation(); if(confirm("Delete card?")){ deleteCard(card.id); } };
      actions.appendChild(editBtn); actions.appendChild(delBtn);
    }
    head.appendChild(actions);

    el.appendChild(head);

    // links area (expand/collapse)
    const linksArea = document.createElement("div");
    linksArea.className = "links-area";
    // links grid inside
    const linksGrid = document.createElement("div");
    linksGrid.className = "links-grid";

    // populate link tiles
    card.links.forEach(l=>{
      const lt = document.createElement("div");
      lt.className = "link-tile";
      lt.dataset.linkId = l.id;
      lt.innerHTML = `<div class="link-title">${l.title}</div><div class="link-url">${l.url}</div>`;
      lt.onclick = ()=> window.open(l.url, "_blank");
      // admin inline actions for links
      if(isAdmin()){
        const la = document.createElement("div");
        la.style.position = "absolute"; la.style.right = "12px"; la.style.bottom = "12px"; la.style.display="flex"; la.style.gap="8px";
        const editL = document.createElement("button"); editL.className = "small-btn"; editL.textContent = "Edit"; editL.onclick = (ev)=>{ ev.stopPropagation(); openEditLink(card.id, l.id); };
        const delL = document.createElement("button"); delL.className = "small-btn small-danger"; delL.textContent = "Del"; delL.onclick = (ev)=>{ ev.stopPropagation(); if(confirm("Delete link?")){ deleteLink(card.id, l.id); } };
        la.appendChild(editL); la.appendChild(delL);
        lt.appendChild(la);
        // drag handlers for link
        lt.draggable = true;
        lt.addEventListener("dragstart", ev=>{
          ev.dataTransfer.setData("text/plain", JSON.stringify({type:"link", cardId: card.id, linkId: l.id}));
        });
      }
      linksGrid.appendChild(lt);
    });

    // admin: add-link button inside expanded area (visible to admin only)
    if(isAdmin()){
      const addTile = document.createElement("div");
      addTile.className = "link-tile";
      addTile.style.justifyContent = "center"; addTile.style.alignItems = "center"; addTile.style.fontSize = "28px"; addTile.textContent = "+";
      addTile.onclick = (ev)=>{ ev.stopPropagation(); openAddLink(card.id); };
      linksGrid.appendChild(addTile);
    }

    linksArea.appendChild(linksGrid);
    el.appendChild(linksArea);

    // footer area (drag handle only for admin)
    const foot = document.createElement("div");
    foot.className = "card-footer";
    const left = document.createElement("div"); left.className = "muted"; left.textContent = "Click to expand";
    const right = document.createElement("div");
    if(isAdmin()){
      // drag handle
      const dh = document.createElement("span"); dh.className = "small-btn"; dh.textContent = "Move"; dh.style.cursor="grab";
      right.appendChild(dh);
    }
    foot.appendChild(left); foot.appendChild(right);
    el.appendChild(foot);

    // expand/collapse logic
    el.addEventListener("click", (ev)=>{
      // toggle expand only when clicking outside admin action buttons
      if( ev.target.closest('.small-btn') ) return;
      const expanded = linksArea.style.display === "block";
      // collapse others
      document.querySelectorAll('.links-area').forEach(x=> x.style.display = "none");
      if(!expanded){
        linksArea.style.display = "block";
      } else {
        linksArea.style.display = "none";
      }
    });

    // admin: make card draggable for ordering
    if(isAdmin()){
      el.draggable = true;
      el.addEventListener("dragstart", ev=>{
        ev.dataTransfer.setData("text/plain", JSON.stringify({type:"card",cardId:card.id}));
      });
      el.addEventListener("dragover", ev=>{ ev.preventDefault(); el.style.opacity = "0.7"; });
      el.addEventListener("dragleave", ()=> el.style.opacity = "1");
      el.addEventListener("drop", ev=>{
        ev.preventDefault(); el.style.opacity = "1";
        try{
          const data = JSON.parse(ev.dataTransfer.getData("text/plain") || "{}");
          if(data.type === "card" && data.cardId !== card.id){
            const fromIdx = cards.findIndex(c => c.id === data.cardId);
            const toIdx = cards.findIndex(c => c.id === card.id);
            const [m] = cards.splice(fromIdx,1);
            cards.splice(toIdx,0,m);
            saveAll(); render();
          } else if(data.type === "link"){
            // move link from one card to this card
            const {cardId:srcCardId, linkId} = data;
            if(srcCardId === card.id) return;
            const src = cards.find(c=>c.id===srcCardId);
            const linkObj = src.links.find(x=>x.id===linkId);
            src.links = src.links.filter(x=>x.id!==linkId);
            card.links.push(linkObj);
            saveAll(); render();
          }
        }catch(e){}
      });
    }

    // append
    cardsGrid.appendChild(el);
  });

  // Add-card tile at end (admin only)
  if(isAdmin()){
    const addCard = document.createElement("div");
    addCard.className = "add-card";
    addCard.textContent = "+ Add Card";
    addCard.onclick = ()=> openAddCard();
    cardsGrid.appendChild(addCard);
  }
}

/* ---------- MODALS ---------- */
function openModal(html){
  modalContent.innerHTML = html;
  modalBackdrop.style.display = "flex";
}
function closeModal(){ modalBackdrop.style.display = "none"; modalContent.innerHTML = ""; }

/* ---------- CRUD: Cards & Links ---------- */
function openAddCard(){
  openModal(`<h3>Add Card</h3>
    <input id="cardName" placeholder="Card name (eg. IT, Finance)">
    <input id="cardIcon" placeholder="Icon/emot (eg. ðŸ’»)">
    <div style="margin-top:12px" class="row"><button id="saveCard" class="btn-primary">Save</button></div>`);
  document.getElementById("saveCard").onclick = ()=>{
    const name = document.getElementById("cardName").value.trim();
    const icon = document.getElementById("cardIcon").value.trim() || "ðŸ”—";
    if(!name) return alert("Enter card name");
    cards.push({id:uid(), name, icon, links:[]});
    saveAll(); closeModal(); render();
  };
}
function openEditCard(cardId){
  const c = cards.find(x=>x.id===cardId);
  openModal(`<h3>Edit Card</h3>
    <input id="cardName" value="${escapeHtml(c.name)}">
    <input id="cardIcon" value="${escapeHtml(c.icon||'ðŸ”—')}">
    <div class="row"><button id="saveCard" class="btn-primary">Save</button></div>`);
  document.getElementById("saveCard").onclick = ()=>{
    c.name = document.getElementById("cardName").value.trim();
    c.icon = document.getElementById("cardIcon").value.trim() || "ðŸ”—";
    saveAll(); closeModal(); render();
  };
}
function deleteCard(cardId){
  if(!confirm("Delete this card and all its links?")) return;
  cards = cards.filter(x=>x.id!==cardId);
  saveAll(); render();
}

function openAddLink(cardId){
  const c = cards.find(x=>x.id===cardId);
  openModal(`<h3>Add Link to ${escapeHtml(c.name)}</h3>
    <input id="lTitle" placeholder="Title">
    <input id="lUrl" placeholder="https://example.com">
    <div class="row"><button id="saveLink" class="btn-primary">Save</button></div>`);
  document.getElementById("saveLink").onclick = ()=>{
    const t = document.getElementById("lTitle").value.trim();
    const u = document.getElementById("lUrl").value.trim();
    if(!t||!u) return alert("All fields required");
    c.links.push({id:uid(), title:t, url:u});
    saveAll(); closeModal(); render();
  };
}
function openEditLink(cardId, linkId){
  const c = cards.find(x=>x.id===cardId);
  const l = c.links.find(x=>x.id===linkId);
  openModal(`<h3>Edit Link</h3>
    <input id="lTitle" value="${escapeHtml(l.title)}">
    <input id="lUrl" value="${escapeHtml(l.url)}">
    <div class="row"><button id="saveLink" class="btn-primary">Save</button></div>`);
  document.getElementById("saveLink").onclick = ()=>{
    l.title = document.getElementById("lTitle").value.trim();
    l.url = document.getElementById("lUrl").value.trim();
    saveAll(); closeModal(); render();
  };
}
function deleteLink(cardId, linkId){
  const c = cards.find(x=>x.id===cardId);
  c.links = c.links.filter(x=>x.id!==linkId);
  saveAll(); render();
}

/* ---------- Admin Login / PIN / Settings ---------- */
btnAdminToggle.onclick = ()=>{
  if(isAdmin()){
    if(confirm("Logout admin?")) logoutAdmin();
    return;
  }
  openModal(`<h3>Admin Login (6-digit PIN)</h3>
    <input id="pinInput" class="pin-input" maxlength="6" placeholder="â—â—â—â—â—â—">
    <div class="row"><button id="doLogin" class="btn-primary">Login</button></div>`);
  document.getElementById("doLogin").onclick = ()=>{
    const v = (document.getElementById("pinInput").value||"").trim();
    if(v===ADMIN_PIN){
      sessionStorage.setItem(SESSION_KEY,"true");
      sessionStorage.setItem("lastActivity", Date.now());
      closeModal(); render();
      startActivityWatcher();
      alert("Admin login successful");
    } else alert("Incorrect PIN");
  };
};

function logoutAdmin(){
  sessionStorage.removeItem(SESSION_KEY);
  stopActivityWatcher();
  render();
}

/* Settings (change PIN) */
document.getElementById("btnSettings").onclick = ()=>{
  if(!isAdmin()) return alert("Admin only");
  openModal(`<h3>Settings â€” Change PIN</h3>
    <input id="oldPin" class="pin-input" maxlength="6" placeholder="Current PIN">
    <input id="newPin" class="pin-input" maxlength="6" placeholder="New PIN">
    <input id="newPin2" class="pin-input" maxlength="6" placeholder="Confirm PIN">
    <div class="row"><button id="savePin" class="btn-primary">Save</button></div>`);
  document.getElementById("savePin").onclick = ()=>{
    const o = (document.getElementById("oldPin").value||"").trim();
    const n = (document.getElementById("newPin").value||"").trim();
    const c = (document.getElementById("newPin2").value||"").trim();
    if(o !== ADMIN_PIN) return alert("Current PIN incorrect");
    if(n.length !== 6) return alert("PIN must be 6 digits");
    if(n !== c) return alert("PINs do not match");
    ADMIN_PIN = n;
    localStorage.setItem(PIN_KEY, n);
    alert("PIN updated. You will be logged out.");
    logoutAdmin(); closeModal();
  };
};

/* ---------- Import / Export (Excel) ---------- */
document.getElementById("btnExport").onclick = ()=>{
  if(!isAdmin()) return alert("Admin only");
  // flatten to rows: CardName, LinkTitle, URL
  const rows = [];
  cards.forEach(c=>{
    c.links.forEach(l => rows.push({Card: c.name, Title: l.title, URL: l.url}));
  });
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Links");
  XLSX.writeFile(wb, "DashboardCards.xlsx");
};

document.getElementById("btnImport").onclick = ()=>{
  if(!isAdmin()) return alert("Admin only");
  openModal(`<h3>Import (CSV or XLSX)</h3>
    <div class="muted">Columns: <b>Card, Title, URL</b>. Existing links will be replaced by imported rows grouped by Card (new cards auto-created).</div>
    <input id="fileImp" type="file" accept=".csv,.xlsx">
    <div class="row"><button id="doImport" class="btn-primary">Import</button></div>`);
  document.getElementById("doImport").onclick = ()=>{
    const f = document.getElementById("fileImp").files[0]; if(!f) return alert("Choose a file");
    const reader = new FileReader();
    reader.onload = e=>{
      const wb = XLSX.read(e.target.result, {type:"binary"});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws);
      // reset cards & build from rows
      const map = {};
      rows.forEach(r=>{
        const cname = (r.Card || "").toString().trim();
        const title = (r.Title || "").toString().trim();
        const url = (r.URL || "").toString().trim();
        if(!cname || !title) return;
        if(!map[cname]) map[cname] = [];
        map[cname].push({id:uid(), title, url});
      });
      // rebuild cards: keep existing order for matching names, then add new ones
      const newCards = [];
      Object.keys(map).forEach(name=>{
        // find existing card with same name (case-insensitive)
        let found = cards.find(c => c.name.toLowerCase() === name.toLowerCase());
        if(found){
          newCards.push({id:found.id, name:found.name, icon:found.icon, links: map[name]});
        } else {
          newCards.push({id:uid(), name, icon:"ðŸ”—", links: map[name]});
        }
      });
      cards = newCards;
      saveAll(); closeModal(); render();
      alert("Import complete");
    };
    reader.readAsBinaryString(f);
  };
};

/* ---------- Search box ---------- */
searchBox.addEventListener("input", ()=> render());

/* ---------- Initialize UI and event wiring ---------- */
function initialSetup(){
  // wire admin-control visibility
  updateAdminControls();
  // attach add card/link top buttons
  document.getElementById("btnAddCard").onclick = ()=> {
    if(!isAdmin()) return alert("Admin only");
    openAddCard();
  };
  document.getElementById("btnAddLink").onclick = ()=> {
    if(!isAdmin()) return alert("Admin only");
    // if admin clicks top +Link: show card selector first
    openModal(`<h3>Add Link</h3>
      <select id="selCard">${cards.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('')}</select>
      <input id="lTitle" placeholder="Title">
      <input id="lUrl" placeholder="https://example.com">
      <div class="row"><button id="saveLinkTop" class="btn-primary">Save</button></div>`);
    document.getElementById("saveLinkTop").onclick = ()=>{
      const cid = document.getElementById("selCard").value;
      const t = document.getElementById("lTitle").value.trim();
      const u = document.getElementById("lUrl").value.trim();
      if(!t||!u) return alert("All fields required");
      const c = cards.find(x=>x.id===cid);
      c.links.push({id:uid(), title:t, url:u});
      saveAll(); closeModal(); render();
    };
  };

  // delete top - opens modal to choose card or link
  document.getElementById("btnDelete").onclick = ()=> {
    if(!isAdmin()) return alert("Admin only");
    openModal(`<h3>Delete</h3>
      <label><input type="radio" name="delType" value="card" checked> Card</label><br>
      <label><input type="radio" name="delType" value="link"> Link</label>
      <div id="delWrap" style="margin-top:10px"><select id="delSel">${cards.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('')}</select></div>
      <div class="row"><button id="doDel" class="btn-danger">Delete</button></div>`);
    document.querySelectorAll("input[name='delType']").forEach(r=> r.onchange = ()=>{
      if(r.value==='card' && r.checked){
        document.getElementById("delWrap").innerHTML = `<select id="delSel">${cards.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('')}</select>`;
      } else if(r.checked){
        const opts = cards.flatMap(c => c.links.map(l=> `<option value="${c.id}__${l.id}">${escapeHtml(c.name)} â†’ ${escapeHtml(l.title)}</option>`)).join('');
        document.getElementById("delWrap").innerHTML = `<select id="delSel">${opts}</select>`;
      }
    });
    document.getElementById("doDel").onclick = ()=>{
      const val = document.getElementById("delSel").value;
      if(val.includes("__")){
        const [cid,lid] = val.split("__");
        const c = cards.find(x=>x.id===cid);
        c.links = c.links.filter(x=>x.id!==lid);
      } else {
        if(!confirm("Delete card and its links?")) return;
        cards = cards.filter(x=>x.id!==val);
      }
      saveAll(); closeModal(); render();
    };
  };

  // Export & Import wired earlier via buttons binding
}

/* ---------- utility ---------- */
function escapeHtml(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }

/* ---------- Start ---------- */
initialSetup();
render();
updateAdminControls();
if(isAdmin()) startActivityWatcher();

</script>
</body>
</html>
