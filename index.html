<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Links - v8 (PIN + Settings + Public Locked)</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{--primary:#1b75bb;--primary-dark:#0f5c94;--bg:#f4f8fc;--card:#fff;--border:#dbe7f3;--text:#1b2e3c;--muted:#6e7c87;--radius:12px;}
  *{box-sizing:border-box}
  body{margin:0;padding:30px;font-family:Inter,Segoe UI,Arial;background:var(--bg);color:var(--text);}
  header{max-width:1150px;margin:0 auto 22px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:22px}
  .title{font-weight:700;font-size:18px}
  .muted{font-size:12px;color:var(--muted)}
  .left-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:10px}
  input.search{padding:9px 12px;border-radius:10px;border:1px solid var(--border);width:240px}
  select{padding:9px;border-radius:10px;border:1px solid var(--border)}
  .controls{display:flex;gap:8px}
  button{padding:9px 12px;border-radius:10px;border:1px solid var(--border);cursor:pointer;font-weight:600;background:#fff;color:var(--primary-dark)}
  .btn-primary{background:var(--primary);color:#fff;border:0}
  .btn-danger{background:#c0392b;color:#fff;border:0}
  .small{padding:7px 9px}
  .status-badge{font-size:13px;padding:6px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:#fff;}
  main{max-width:1150px;margin:0 auto}
  .category-row{margin-top:22px;padding:2px;border-radius:12px;transition:.12s;background:transparent}
  .category-header{display:flex;gap:12px;align-items:center}
  .cat-icon{width:46px;height:46px;border-radius:10px;background:#eaf3fc;display:flex;align-items:center;justify-content:center;font-size:20px}
  .cat-title{font-size:18px;font-weight:700}
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(235px,1fr));gap:12px;margin-top:12px;padding:4px}
  .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;min-height:90px;box-shadow:0 4px 12px rgba(0,0,0,0.05);cursor:grab;user-select:none;transition:.12s;display:flex;flex-direction:column;gap:6px}
  .card:hover{transform:translateY(-4px)}
  .card.dragging{opacity:0.5}
  .card-title{font-weight:700}
  .card-url{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .add-card{background:#eef5ff;border:2px dashed var(--primary);display:flex;align-items:center;justify-content:center;font-size:32px;border-radius:12px;cursor:pointer}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:999}
  .modal{background:#fff;padding:18px;border-radius:12px;width:420px;max-width:100%}
  .row{display:flex;justify-content:flex-end;gap:10px;margin-top:14px}
  input,select{margin-top:6px;width:100%;padding:10px;border-radius:8px;border:1px solid var(--border)}
  .pin-input{letter-spacing:8px;font-size:20px;text-align:center;max-width:220px}
</style>
</head>

<body>

<header>
  <div class="brand">
    <div class="logo">DL</div>
    <div>
      <div class="title">Dashboard Links ‚Äì v8</div>
      <div class="muted">Admin PIN + Settings + Public Read-only</div>
    </div>
  </div>

  <div class="left-controls">
    <input class="search" id="searchBox" placeholder="Search links..." />
    <select id="catSort">
      <option value="default">Default</option>
      <option value="alpha">A ‚Üí Z</option>
      <option value="alpha-desc">Z ‚Üí A</option>
      <option value="most">Most links</option>
      <option value="least">Least links</option>
    </select>
  </div>

  <div class="controls" id="controlsTop">
    <button id="btnAddCategory" style="display:none">+ Category</button>
    <button class="btn-primary" id="btnAddLink" style="display:none">+ Link</button>
    <button id="btnDelete" style="display:none">üóë Delete</button>
    <button id="btnExport" style="display:none">üì§ Export</button>
    <button id="btnImport" style="display:none">üì• Import</button>
    <button id="btnSettings" style="display:none">‚öôÔ∏è Settings</button>

    <button id="btnAdminToggle">üîí Admin Login</button>
    <div id="adminStatus" class="status-badge" style="display:none">Admin</div>
  </div>
</header>

<main id="mainArea"></main>

<div class="modal-backdrop" id="modalBackdrop"><div class="modal" id="modalContent"></div></div>

<script>
/* ---------- CONFIG ---------- */
const DEFAULT_PIN = "123456"; // Initial PIN
const AUTO_LOCK_MS = 5 * 60 * 1000;

/* Values stored */
const PIN_KEY = "dashboard_admin_pin";
const CATS_KEY="cats_v8";
const LINKS_KEY="links_v8";
const SESSION_KEY="session_admin_v8";

/* Load PIN or set default */
let ADMIN_PIN = localStorage.getItem(PIN_KEY) || DEFAULT_PIN;

/* Categories & Links */
let categories = JSON.parse(localStorage.getItem(CATS_KEY)) || [
  {id:"c1",name:"HR"},
  {id:"c2",name:"Production"},
  {id:"c3",name:"Finance"},
  {id:"c4",name:"IT"},
  {id:"c5",name:"Admin"}
];

let links = JSON.parse(localStorage.getItem(LINKS_KEY)) || [];

/* Helpers */
const saveAll=()=>{localStorage.setItem(CATS_KEY,JSON.stringify(categories));localStorage.setItem(LINKS_KEY,JSON.stringify(links));};
const uid=()=> "id"+Math.random().toString(36).slice(2);
const icon=cat=>({HR:"üë®‚Äçüíº",Production:"üè≠",Finance:"üí∞",IT:"üíª",Admin:"üè¢"}[cat]||"üîó");

function isAdmin(){
  return sessionStorage.getItem(SESSION_KEY)==="true";
}

function updateUIControls(){
  const admin=isAdmin();
  ["btnAddCategory","btnAddLink","btnDelete","btnExport","btnImport","btnSettings"]
    .forEach(id=>document.getElementById(id).style.display = admin? "" : "none");

  btnAdminToggle.textContent = admin? "üîì Logout" : "üîí Admin Login";
  adminStatus.style.display = admin? "" : "none";
}

let inactivityTimer=null;

/* Auto-lock */
function resetActivity(){
  if(!isAdmin()) return;
  sessionStorage.setItem("lastActivity",Date.now());
}
function startInactivityWatcher(){
  clearInterval(inactivityTimer);
  inactivityTimer=setInterval(()=>{
    if(!isAdmin()) return;
    let last=parseInt(sessionStorage.getItem("lastActivity")||0);
    if(Date.now()-last>AUTO_LOCK_MS){
      sessionStorage.removeItem(SESSION_KEY);
      alert("Auto-locked after 5 minutes inactivity.");
      render();
    }
  },4000);
}
function enableAdmin(){
  sessionStorage.setItem(SESSION_KEY,"true");
  sessionStorage.setItem("lastActivity",Date.now());
  updateUIControls();
  startInactivityWatcher();
}
function disableAdmin(){
  sessionStorage.removeItem(SESSION_KEY);
  updateUIControls();
}

/* Render */
const main=document.getElementById("mainArea");
const search=document.getElementById("searchBox");
const sort=document.getElementById("catSort");

function applySort(list){
  const s=sort.value;
  if(s==="alpha") return [...list].sort((a,b)=>a.name.localeCompare(b.name));
  if(s==="alpha-desc") return [...list].sort((a,b)=>b.name.localeCompare(a.name));
  if(s==="most") return [...list].sort((a,b)=>links.filter(l=>l.category==b.id).length - links.filter(l=>l.category==a.id).length);
  if(s==="least") return [...list].sort((a,b)=>links.filter(l=>l.category==a.id).length - links.filter(l=>l.category==b.id).length);
  return list;
}

function render(){
  updateUIControls();
  const q=(search.value||"").toLowerCase();
  main.innerHTML="";
  const admin=isAdmin();
  const cats=applySort(categories);

  cats.forEach(cat=>{
    const row=document.createElement("div");
    row.className="category-row";

    if(admin) row.draggable=true;
    row.innerHTML=`
      <div class="category-header">
        <div class="cat-icon">${icon(cat.name)}</div>
        <div>
          <div class="cat-title">${cat.name}</div>
          <div class="muted">${links.filter(l=>l.category==cat.id).length} links</div>
        </div>
      </div>
    `;

    const cards=document.createElement("div");
    cards.className="cards";

    links.forEach(l=>{
      if(l.category!==cat.id) return;
      if(q && !l.title.toLowerCase().includes(q)) return;

      const c=document.createElement("div");
      c.className="card";
      c.innerHTML=`<div class="card-title">${l.title}</div><div class="card-url">${l.url}</div>`;
      c.onclick=()=>window.open(l.url,"_blank");

      if(admin){
        c.draggable=true;
        c.addEventListener("dragstart",ev=>{
          c.classList.add("dragging");
          ev.dataTransfer.setData("text/plain",JSON.stringify({type:"link",payload:l}));
        });
        c.addEventListener("dragend",()=>c.classList.remove("dragging"));
      }

      cards.appendChild(c);
    });

    /* Show + add card ONLY: when admin AND category has links */
    const hasLinks=links.some(l=>l.category===cat.id);
    if(admin && hasLinks){
      const add=document.createElement("div");
      add.className="card add-card";
      add.textContent="+";
      add.onclick=()=>openAddLink(cat.id);
      cards.appendChild(add);
    }

    /* If admin: Allow category-level drop */
    if(admin){
      row.addEventListener("dragover",e=>e.preventDefault());
      row.addEventListener("drop",e=>{
        const data=JSON.parse(e.dataTransfer.getData("text/plain")||"{}");
        if(data.type==="cat" && data.id!==cat.id){
          const from=categories.findIndex(x=>x.id===data.id);
          const to=categories.findIndex(x=>x.id===cat.id);
          const [m]=categories.splice(from,1);
          categories.splice(to,0,m);
          saveAll();render();
        }
      });
    }

    row.appendChild(cards);
    main.appendChild(row);
  });

  if(!isAdmin()){
    const info=document.createElement("div");
    info.className="muted";
    info.style.marginTop="20px";
    info.textContent="Public view (read-only). Login as admin to manage links.";
    main.appendChild(info);
  }
}

/* Modal */
const overlay=document.getElementById("modalBackdrop");
const modal=document.getElementById("modalContent");
function openModal(html){modal.innerHTML=html;overlay.style.display="flex";}
function closeModal(){overlay.style.display="none";modal.innerHTML="";}
overlay.onclick=e=>{if(e.target===overlay) closeModal();};

/* Admin Login */
btnAdminToggle.onclick=()=>{
  if(isAdmin()){
    if(confirm("Logout admin?")){
      disableAdmin(); render();
    }
    return;
  }

  openModal(`
    <h3>Admin Login</h3>
    <input id="pin" class="pin-input" maxlength="6" placeholder="PIN">
    <div class="row"><button class="btn-primary" id="loginBtn">Login</button></div>
  `);

  loginBtn.onclick=()=>{
    const val=document.getElementById("pin").value.trim();
    if(val===ADMIN_PIN){
      enableAdmin(); closeModal(); render();
    } else alert("Incorrect PIN");
  };
};

/* Settings (change PIN) */
btnSettings.onclick=()=>{
  if(!isAdmin())return;
  openModal(`
    <h3>Admin Settings ‚Äî Change PIN</h3>
    <input id="oldPin" class="pin-input" maxlength="6" placeholder="Current PIN">
    <input id="newPin" class="pin-input" maxlength="6" placeholder="New PIN">
    <input id="newPin2" class="pin-input" maxlength="6" placeholder="Confirm New PIN">
    <div class="row"><button class="btn-primary" id="savePin">Save</button></div>
  `);

  savePin.onclick=()=>{
    const o=oldPin.value.trim(), n=newPin.value.trim(), c=newPin2.value.trim();
    if(o!==ADMIN_PIN)return alert("Current PIN incorrect");
    if(n.length!==6)return alert("PIN must be 6 digits");
    if(n!==c)return alert("PINs do not match");

    ADMIN_PIN=n;
    localStorage.setItem(PIN_KEY,n);

    alert("PIN updated. Please login again.");
    disableAdmin();
    closeModal();
    render();
  };
};

/* Add Cat */
btnAddCategory.onclick=()=>{
  openModal(`
    <h3>Add Category</h3>
    <input id="catName" placeholder="Category name">
    <div class="row"><button class="btn-primary" id="saveCat">Save</button></div>
  `);

  saveCat.onclick=()=>{
    let n=catName.value.trim();
    if(!n)return alert("Name?");
    categories.push({id:uid(),name:n});
    saveAll();closeModal();render();
  };
};

/* Add Link */
function openAddLink(catId){
  const opts=categories.map(c=>`<option value="${c.id}" ${c.id===catId?"selected":""}>${c.name}</option>`).join("");
  openModal(`
    <h3>Add Link</h3>
    <input id="lTitle" placeholder="Title">
    <input id="lUrl" placeholder="https://example.com">
    <select id="lCat">${opts}</select>
    <div class="row"><button class="btn-primary" id="saveLink">Save</button></div>
  `);
  saveLink.onclick=()=>{
    let t=lTitle.value.trim(),u=lUrl.value.trim();
    if(!t||!u)return alert("All fields required");
    links.push({id:uid(),title:t,url:u,category:lCat.value});
    saveAll();closeModal();render();
  };
}
btnAddLink.onclick=()=>openAddLink(categories[0].id);

/* Delete */
btnDelete.onclick=()=>{
  const c=categories.map(x=>`<option value="${x.id}">${x.name}</option>`).join("");
  const l=links.map(x=>`<option value="${x.id}">${x.title}</option>`).join("");

  openModal(`
    <h3>Delete</h3>
    <label><input type="radio" name="t" value="cat" checked> Category</label><br>
    <label><input type="radio" name="t" value="link"> Link</label>
    <div id="delWrap" style="margin-top:10px"><select id="delVal">${c}</select></div>
    <div class="row"><button class="btn-danger" id="doDelete">Delete</button></div>
  `);

  document.querySelectorAll("input[name='t']").forEach(x=>x.onchange=()=>{
    delWrap.innerHTML = x.value==="cat"? `<select id="delVal">${c}</select>`:`<select id="delVal">${l}</select>`;
  });

  doDelete.onclick=()=>{
    const t=document.querySelector("input[name='t']:checked").value;
    const id=delVal.value;
    if(t==="cat"){
      if(links.some(x=>x.category===id))return alert("Not empty");
      categories=categories.filter(x=>x.id!==id);
    } else {
      links=links.filter(x=>x.id!==id);
    }
    saveAll();closeModal();render();
  };
};

/* Export & Import same as v7 */
btnExport.onclick=()=>{
  const data=links.map(l=>({Category:categories.find(c=>c.id===l.category)?.name,Title:l.title,URL:l.url}));
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Links");
  XLSX.writeFile(wb,"DashboardLinks.xlsx");
};
btnImport.onclick=()=>{
  openModal(`
    <h3>Import</h3>
    <input type="file" id="impF" accept=".csv,.xlsx">
    <div class="row"><button class="btn-primary" id="doImp">Import</button></div>
  `);
  doImp.onclick=()=>{
    const f=impF.files[0]; if(!f)return;
    const r=new FileReader();
    r.onload=e=>{
      const wb=XLSX.read(e.target.result,{type:"binary"});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws);
      links=[];
      rows.forEach(r=>{
        const cname=(r.Category||"").trim();
        if(!cname)return;
        let cat=categories.find(c=>c.name.toLowerCase()==cname.toLowerCase());
        if(!cat){ cat={id:uid(),name:cname};categories.push(cat);}
        links.push({id:uid(),title:r.Title||"",url:r.URL||"",category:cat.id});
      });
      saveAll();closeModal();render();
    };
    r.readAsBinaryString(f);
  };
};

/* Search / Sort */
search.oninput=render;
sort.onchange=render;

/* Init */
if(isAdmin()) startInactivityWatcher();
render();

</script>
</body>
</html>
