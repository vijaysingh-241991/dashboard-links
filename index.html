<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Links â€“ v9.3</title>

<!-- SheetJS for Import/Export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#eef6fb;
  --card-bg: rgba(255,255,255,0.92);
  --panel-bg: rgba(255,255,255,0.56);
  --muted:#6e7c87;
  --primary:#1b75bb;
  --accent:#0f5c94;
  --radius:14px;
  --shadow:0 10px 30px rgba(20,40,80,0.06);
  --glass-shadow: 0 18px 50px rgba(16,40,80,0.06);
  font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;padding:0}
body{
  margin:0;padding:28px;background:linear-gradient(180deg,#f8fbff 0%, #eef6fb 100%);
  -webkit-font-smoothing:antialiased;color:#12202b;
  position:relative;
  min-height:100vh;
}

/* EBWS center glass banner */
body::before{
  content:"";
  position:absolute; top:86px; left:50%; transform:translateX(-50%);
  width:1100px; height:320px;
  background: url("banner.jpg") no-repeat center/contain;
  opacity:0.10; filter: blur(3px) saturate(0.95); z-index:0; pointer-events:none;
}

/* Header row */
.header-wrap{max-width:1200px;margin:0 auto;position:relative;z-index:6}
.header{
  display:flex;align-items:center;justify-content:space-between;gap:12px;padding:6px 12px 6px 0;
}
.brand{display:flex;gap:12px;align-items:center}
.logo{
  width:64px;height:64px;border-radius:14px;background:#fff center/cover no-repeat url("logo.jpg");
  box-shadow:var(--shadow);flex:0 0 64px;
}
.title{font-weight:700;font-size:20px}
.subtitle{font-size:13px;color:var(--muted)}

/* Toolbar (Option A) - glass bar under header */
.toolbar {
  margin-top:12px; max-width:1200px; margin-left:auto;margin-right:auto;
  background: linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,0.6));
  border-radius:14px; padding:12px 16px; display:flex; align-items:center; gap:12px;
  box-shadow: var(--glass-shadow); border:1px solid rgba(255,255,255,0.7); z-index:6; position:relative;
}
.toolbar-left{display:flex;align-items:center;gap:12px}
.search{padding:10px 12px;border-radius:10px;border:1px solid rgba(10,20,40,0.06);min-width:300px}
.toolbar-right{display:flex;align-items:center;gap:8px;margin-left:auto}

/* toolbar buttons */
.btn{padding:9px 12px;border-radius:10px;border:1px solid rgba(10,20,40,0.06);background:linear-gradient(180deg,#fff,#f7fbff);cursor:pointer;font-weight:700;color:var(--primary)}
.btn-primary{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;border:0;box-shadow:0 8px 18px rgba(27,117,187,0.12)}
.btn.disabled{opacity:0.42;pointer-events:none}
.status{padding:6px 10px;border-radius:10px;background:rgba(255,255,255,0.7);border:1px solid rgba(0,0,0,0.04);font-weight:600;color:var(--primary)}

/* main panel */
.container{max-width:1200px;margin:18px auto 60px;position:relative;z-index:5}
.panel{
  padding:18px;border-radius:18px;background:var(--panel-bg);backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);box-shadow:0 18px 40px rgba(16,35,70,0.04);border:1px solid rgba(255,255,255,0.6);
}

/* cards grid (Option A wide horizontal cards as earlier) */
.cards-grid{
  display:grid; grid-template-columns: repeat(3, 1fr); gap:18px;
  align-items:start;
}
@media(max-width:1100px){ .cards-grid{grid-template-columns:repeat(2,1fr)} }
@media(max-width:700px){ .cards-grid{grid-template-columns:1fr} }

/* card */
.card{
  background:var(--card-bg); border-radius:12px; padding:14px; min-height:120px; position:relative;
  box-shadow:var(--shadow); border:1px solid rgba(10,20,40,0.03); transition:transform .18s ease, box-shadow .18s ease;
}
.card:hover{transform:translateY(-6px);box-shadow:0 22px 48px rgba(20,40,80,0.08)}
.card-head{display:flex;gap:12px;align-items:center}
.card-icon{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px}
.card-title{font-weight:800;font-size:16px}
.card-sub{font-size:13px;color:var(--muted);margin-top:6px}

/* links area */
.links-area{
  margin-top:12px;border-radius:10px;padding:12px;background:rgba(245,250,255,0.86);border:1px solid rgba(10,30,60,0.03);
  display:none; transition:all .18s ease; overflow:visible;
}
.links-grid{
  display:grid; gap:12px;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}
@media(max-width:520px){ .links-grid{grid-template-columns:1fr} }

/* link tile */
.link-tile{
  background:#fff;border-radius:10px;padding:12px;min-height:70px;border:1px solid rgba(10,20,40,0.04);
  display:flex;flex-direction:column;justify-content:center;cursor:pointer;position:relative;
  box-shadow:0 8px 18px rgba(20,40,80,0.03);
}
.link-title{font-weight:700}
.link-url{font-size:12px;color:var(--muted);margin-top:8px;display:block}

/* admin small buttons */
.tile-actions{position:absolute;right:12px;top:12px;display:flex;gap:8px}
.small-btn{padding:6px 8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.85);cursor:pointer;font-weight:700;color:var(--primary)}
.small-danger{background:#fff0f0;border:1px solid rgba(200,50,50,0.12);color:#c0392b}

/* add-card tile */
.add-card{display:flex;align-items:center;justify-content:center;border:2px dashed rgba(27,117,187,0.14);background:linear-gradient(180deg,rgba(255,255,255,0.7),rgba(245,250,255,0.7));border-radius:12px;min-height:120px;font-size:18px;color:var(--primary);cursor:pointer}

/* modal */
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
.modal{background:#fff;padding:16px;border-radius:12px;max-width:520px;width:100%}
input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(10,20,40,0.06);margin-top:8px}

/* helpers */
.hidden{display:none !important}
.hint{font-size:13px;color:var(--muted);margin-top:12px}

/* focus / a11y */
:focus{outline:2px solid rgba(27,117,187,0.16);outline-offset:2px}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header-wrap">
  <div class="header">
    <div class="brand">
      <div class="logo" title="EBWS"></div>
      <div>
        <div class="title">Dashboard Links â€“ v9.3</div>
        <div class="subtitle">Cards view (Admin editable) â€¢ Glass UI</div>
      </div>
    </div>

    <div style="display:flex;align-items:center;gap:12px">
      <input id="searchTop" class="search" placeholder="Search links or cards..." />
      <button id="btnAdminToggle" class="btn">ðŸ”’ Admin Login</button>
      <span id="adminStatus" class="status hidden">Admin</span>
    </div>
  </div>

  <!-- TOOLBAR (Option A) -->
  <div class="toolbar" role="toolbar" aria-label="Admin tools">
    <div class="toolbar-left">
      <button id="btnAddCard" class="btn disabled">+ Card</button>
      <button id="btnAddLink" class="btn btn-primary disabled">+ Link</button>
      <button id="btnDelete" class="btn disabled">Delete</button>
      <button id="btnExport" class="btn disabled">Export</button>
      <button id="btnImport" class="btn disabled">Import</button>
      <button id="btnSettings" class="btn disabled">Settings</button>
    </div>
    <div class="toolbar-right">
      <div class="status" style="background:transparent;border:none;color:var(--muted);font-weight:600">Admin controls</div>
      <button id="btnLogout" class="btn hidden" title="Logout">ðŸ”“ Logout</button>
    </div>
  </div>
</div>

<!-- MAIN -->
<div class="container">
  <div class="panel">
    <div class="cards-grid" id="cardsGrid"></div>
    <div class="hint">Public view is read-only. Login as admin to manage cards & links.</div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-back" id="modalBackdrop"><div class="modal" id="modalContent"></div></div>

<script>
/* ------------------ CONFIG ------------------ */
const PIN_KEY = "dashboard_pin_v9_3";
const SESSION_KEY = "dashboard_admin_session_v9_3";
const CARDS_KEY = "dashboard_cards_v9_3";
const AUTO_LOCK_MS = 5*60*1000;
const DEFAULT_PIN = "123456";
let ADMIN_PIN = localStorage.getItem(PIN_KEY) || DEFAULT_PIN;

/* ------------------ DATA LOAD ------------------ */
let cards = JSON.parse(localStorage.getItem(CARDS_KEY) || "null");
if(!cards){
  cards = [
    {id:"card1", name:"IT", icon:"ðŸ’»", links:[
      {id:"l1", title:"Asset Management", url:"http://192.168.96.10:92/login.php"},
      {id:"l2", title:"Network Monitor", url:"http://192.168.96.10:5002/"},
      {id:"l3", title:"Gate_IN/OUT", url:"http://192.168.96.11:88/"},
      {id:"l4", title:"Bhiwadi_ERP", url:"http://192.168.11.4/erp/"},
      {id:"l5", title:"Bhiwadi_Dummy_ERP", url:"http://192.168.11.4/dummy/"},
      {id:"l6", title:"Bhiwadi_MRP", url:"http://192.168.11.1/mrp-ebws/"},
      {id:"l7", title:"Bhiwadi_QAS", url:"http://192.168.11.1/qas-ebws/"}
    ]},
    {id:"card2", name:"HR", icon:"ðŸ‘¨â€ðŸ’¼", links:[]},
    {id:"card3", name:"Finance", icon:"ðŸ’°", links:[]}
  ];
  localStorage.setItem(CARDS_KEY, JSON.stringify(cards));
}

/* ------------------ HELPERS ------------------ */
const uid = ()=> "id"+Math.random().toString(36).slice(2,9);
const isAdmin = ()=> sessionStorage.getItem(SESSION_KEY) === "true";
const cardsGrid = document.getElementById("cardsGrid");
const searchTop = document.getElementById("searchTop");
const modalBackdrop = document.getElementById("modalBackdrop");
const modalContent = document.getElementById("modalContent");
const toolbarButtons = ["btnAddCard","btnAddLink","btnDelete","btnExport","btnImport","btnSettings"];

function saveAll(){ localStorage.setItem(CARDS_KEY, JSON.stringify(cards)); }

/* activity / auto-lock */
let activityTimer = null;
function resetActivity(){ if(!isAdmin()) return; sessionStorage.setItem("lastActivity", Date.now()); }
function startWatcher(){ clearInterval(activityTimer); activityTimer=setInterval(()=>{ if(!isAdmin()) return; const last = parseInt(sessionStorage.getItem("lastActivity")||0); if(Date.now()-last > AUTO_LOCK_MS){ alert("Session locked due to inactivity (5 min)"); logoutAdmin(); render(); } },4000); window.addEventListener("mousemove", resetActivity); window.addEventListener("keydown", resetActivity); window.addEventListener("click", resetActivity); }
function stopWatcher(){ clearInterval(activityTimer); window.removeEventListener("mousemove", resetActivity); window.removeEventListener("keydown", resetActivity); window.removeEventListener("click", resetActivity); }

/* ------------------ UI STATE ------------------ */
function updateToolbarState(){
  const admin = isAdmin();
  toolbarButtons.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(admin) el.classList.remove("disabled"); else el.classList.add("disabled");
  });
  document.getElementById("adminStatus").classList.toggle("hidden", !admin);
  document.getElementById("btnLogout").classList.toggle("hidden", !admin);
  document.getElementById("btnAdminToggle").textContent = admin ? "ðŸ”“ Logout" : "ðŸ”’ Admin Login";
}

/* ------------------ RENDER ------------------ */
function render(){
  updateToolbarState();
  const q = (searchTop.value||"").toLowerCase();
  cardsGrid.innerHTML = "";

  cards.forEach(card=>{
    const matches = card.name.toLowerCase().includes(q) || card.links.some(l => l.title.toLowerCase().includes(q));
    if(q && !matches) return;

    const el = document.createElement("div"); el.className = "card"; el.dataset.cardId = card.id;

    const head = document.createElement("div"); head.className = "card-head";
    head.innerHTML = `<div class="card-icon">${card.icon || "ðŸ”—"}</div>
                      <div style="flex:1">
                        <div class="card-title">${escapeHtml(card.name)}</div>
                        <div class="card-sub">${card.links.length} links</div>
                      </div>`;
    el.appendChild(head);

    // admin actions overlay (edit/delete) - visible only to admin
    if(isAdmin()){
      const act = document.createElement("div"); act.className="tile-actions";
      const edit = document.createElement("button"); edit.className="small-btn"; edit.textContent="Edit"; edit.onclick = (ev)=>{ ev.stopPropagation(); openEditCard(card.id); };
      const del = document.createElement("button"); del.className="small-btn small-danger"; del.textContent="Del"; del.onclick = (ev)=>{ ev.stopPropagation(); if(confirm("Delete card?")) deleteCard(card.id); };
      act.appendChild(edit); act.appendChild(del);
      el.appendChild(act);
    }

    // links area (expandable for ALL users now)
    const linksArea = document.createElement("div"); linksArea.className="links-area";
    const linksGrid = document.createElement("div"); linksGrid.className="links-grid";

    card.links.forEach(l=>{
      const lt = document.createElement("div"); lt.className="link-tile"; lt.dataset.linkId = l.id;
      // show title for all users; show URL only for admin
      lt.innerHTML = `<div class="link-title">${escapeHtml(l.title)}</div>
                      <div class="link-url ${isAdmin() ? '' : 'hidden'}">${escapeHtml(l.url)}</div>`;
      lt.onclick = ()=> window.open(l.url, "_blank");
      if(isAdmin()){
        const la = document.createElement("div"); la.style.position="absolute"; la.style.right="12px"; la.style.bottom="12px"; la.style.display="flex"; la.style.gap="8px";
        const editL = document.createElement("button"); editL.className="small-btn"; editL.textContent="Edit"; editL.onclick = (ev)=>{ ev.stopPropagation(); openEditLink(card.id, l.id); };
        const delL = document.createElement("button"); delL.className="small-btn small-danger"; delL.textContent="Del"; delL.onclick = (ev)=>{ ev.stopPropagation(); if(confirm("Delete link?")) deleteLink(card.id, l.id); };
        la.appendChild(editL); la.appendChild(delL); lt.appendChild(la);

        // drag link
        lt.draggable = true;
        lt.addEventListener("dragstart", ev => {
          ev.dataTransfer.setData("text/plain", JSON.stringify({type:"link", cardId: card.id, linkId: l.id}));
        });
      }
      linksGrid.appendChild(lt);
    });

    // admin add-link tile inside expanded area
    if(isAdmin()){
      const addTile = document.createElement("div"); addTile.className="link-tile"; addTile.style.justifyContent="center"; addTile.style.alignItems="center"; addTile.style.fontSize="26px"; addTile.textContent="+";
      addTile.onclick = (ev)=>{ ev.stopPropagation(); openAddLink(card.id); };
      linksGrid.appendChild(addTile);
    }

    linksArea.appendChild(linksGrid);
    el.appendChild(linksArea);

    // footer hint
    const foot = document.createElement("div"); foot.style.marginTop="12px"; foot.style.display="flex"; foot.style.justifyContent="space-between";
    const left = document.createElement("div"); left.className="muted"; left.textContent = "Click to expand";
    foot.appendChild(left);
    el.appendChild(foot);

    // click toggles expand for everyone (public & admin)
    el.addEventListener("click", ev=>{
      // if click on admin buttons, skip
      if(ev.target.closest('.small-btn')) return;
      const openNow = linksArea.style.display === "block";
      document.querySelectorAll('.links-area').forEach(x=> x.style.display = "none");
      if(!openNow) linksArea.style.display = "block"; else linksArea.style.display = "none";
      // update last activity for admin if admin
      if(isAdmin()) sessionStorage.setItem("lastActivity", Date.now());
    });

    // card drag/drop for admin
    if(isAdmin()){
      el.draggable = true;
      el.addEventListener("dragstart", ev=>{
        ev.dataTransfer.setData("text/plain", JSON.stringify({type:"card", cardId: card.id}));
      });
      el.addEventListener("dragover", ev=> { ev.preventDefault(); el.style.opacity="0.7"; });
      el.addEventListener("dragleave", ()=> el.style.opacity="1");
      el.addEventListener("drop", ev=>{
        ev.preventDefault(); el.style.opacity="1";
        try{
          const data = JSON.parse(ev.dataTransfer.getData("text/plain") || "{}");
          if(data.type === "card" && data.cardId !== card.id){
            const from = cards.findIndex(c=>c.id===data.cardId);
            const to = cards.findIndex(c=>c.id===card.id);
            const [m] = cards.splice(from,1);
            cards.splice(to,0,m);
            saveAll(); render();
          } else if(data.type === "link"){
            const {cardId:srcCardId, linkId} = data;
            if(srcCardId === card.id) return;
            const src = cards.find(c=>c.id===srcCardId);
            const linkObj = src.links.find(x=>x.id===linkId);
            src.links = src.links.filter(x=>x.id!==linkId);
            card.links.push(linkObj);
            saveAll(); render();
          }
        }catch(e){}
      });
    }

    cardsGrid.appendChild(el);
  });

  // admin add-card tile always present in grid but only clickable for admin
  const addCard = document.createElement("div"); addCard.className="add-card"; addCard.textContent="+ Add Card";
  addCard.onclick = ()=> {
    if(!isAdmin()) return alert("Admin only");
    openAddCard();
  };
  cardsGrid.appendChild(addCard);
}

/* ------------------ MODAL ------------------ */
function openModal(html){ modalContent.innerHTML = html; modalBackdrop.style.display = "flex"; }
function closeModal(){ modalBackdrop.style.display = "none"; modalContent.innerHTML = ""; }
modalBackdrop.onclick = (e)=> { if(e.target === modalBackdrop) closeModal(); };

/* ------------------ CRUD ------------------ */
function openAddCard(){
  openModal(`<h3>Add Card</h3>
    <input id="cardName" placeholder="Card name (eg. IT)">
    <input id="cardIcon" placeholder="Icon (emoji or text)">
    <div style="margin-top:12px"><button id="saveCard" class="btn btn-primary">Save</button></div>`);
  document.getElementById("saveCard").onclick = ()=>{
    const n = document.getElementById("cardName").value.trim();
    const ic = document.getElementById("cardIcon").value.trim() || "ðŸ”—";
    if(!n) return alert("Enter card name");
    cards.push({id:uid(),name:n,icon:ic,links:[]});
    saveAll(); closeModal(); render();
  };
}
function openEditCard(cardId){
  const c = cards.find(x=>x.id===cardId);
  openModal(`<h3>Edit Card</h3>
    <input id="cardName" value="${escapeHtml(c.name)}">
    <input id="cardIcon" value="${escapeHtml(c.icon||'ðŸ”—')}">
    <div style="margin-top:12px"><button id="saveCard" class="btn btn-primary">Save</button></div>`);
  document.getElementById("saveCard").onclick = ()=>{
    c.name = document.getElementById("cardName").value.trim();
    c.icon = document.getElementById("cardIcon").value.trim() || "ðŸ”—";
    saveAll(); closeModal(); render();
  };
}
function deleteCard(cardId){
  if(!confirm("Delete card and its links?")) return;
  cards = cards.filter(x=>x.id!==cardId);
  saveAll(); render();
}

function openAddLink(cardId){
  const c = cards.find(x=>x.id===cardId);
  openModal(`<h3>Add Link to ${escapeHtml(c.name)}</h3>
    <input id="lTitle" placeholder="Title">
    <input id="lUrl" placeholder="https://example.com">
    <div style="margin-top:12px"><button id="saveLink" class="btn btn-primary">Save</button></div>`);
  document.getElementById("saveLink").onclick = ()=>{
    const t = document.getElementById("lTitle").value.trim();
    const u = document.getElementById("lUrl").value.trim();
    if(!t||!u) return alert("All fields required");
    c.links.push({id:uid(),title:t,url:u});
    saveAll(); closeModal(); render();
  };
}
function openEditLink(cardId, linkId){
  const c = cards.find(x=>x.id===cardId); const l = c.links.find(x=>x.id===linkId);
  openModal(`<h3>Edit Link</h3>
    <input id="lTitle" value="${escapeHtml(l.title)}">
    <input id="lUrl" value="${escapeHtml(l.url)}">
    <div style="margin-top:12px"><button id="saveLink" class="btn btn-primary">Save</button></div>`);
  document.getElementById("saveLink").onclick = ()=>{
    l.title = document.getElementById("lTitle").value.trim();
    l.url = document.getElementById("lUrl").value.trim();
    saveAll(); closeModal(); render();
  };
}
function deleteLink(cardId, linkId){
  const c = cards.find(x=>x.id===cardId); c.links = c.links.filter(x=>x.id!==linkId); saveAll(); render();
}

/* ------------------ Admin Login / PIN / Settings ------------------ */
document.getElementById("btnAdminToggle").onclick = ()=>{
  if(isAdmin()){
    if(confirm("Logout admin?")) logoutAdmin();
    return;
  }
  openModal(`<h3>Admin Login (6-digit PIN)</h3>
    <input id="pinInput" maxlength="6" placeholder="â—â—â—â—â—â—">
    <div style="margin-top:12px"><button id="doLogin" class="btn btn-primary">Login</button></div>`);
  document.getElementById("doLogin").onclick = ()=>{
    const v = (document.getElementById("pinInput").value||"").trim();
    if(v === ADMIN_PIN){
      sessionStorage.setItem(SESSION_KEY,"true"); sessionStorage.setItem("lastActivity",Date.now()); closeModal(); render(); startWatcher(); alert("Admin login successful");
    } else alert("Incorrect PIN");
  };
};

function logoutAdmin(){
  sessionStorage.removeItem(SESSION_KEY);
  stopWatcher();
  render();
}

/* Settings change PIN (toolbar settings) */
document.getElementById("btnSettings").onclick = ()=>{
  if(!isAdmin()) return alert("Admin only");
  openModal(`<h3>Settings â€” Change PIN</h3>
    <input id="oldPin" maxlength="6" placeholder="Current PIN">
    <input id="newPin" maxlength="6" placeholder="New PIN">
    <input id="newPin2" maxlength="6" placeholder="Confirm PIN">
    <div style="margin-top:12px"><button id="savePin" class="btn btn-primary">Save</button></div>`);
  document.getElementById("savePin").onclick = ()=>{
    const o = (document.getElementById("oldPin").value||"").trim();
    const n = (document.getElementById("newPin").value||"").trim();
    const c = (document.getElementById("newPin2").value||"").trim();
    if(o !== ADMIN_PIN) return alert("Current PIN incorrect");
    if(n.length !== 6) return alert("PIN must be 6 digits");
    if(n !== c) return alert("PINs do not match");
    ADMIN_PIN = n; localStorage.setItem(PIN_KEY,n); alert("PIN updated. Logging out."); logoutAdmin(); closeModal();
  };
};

/* ------------------ Export/Import ------------------ */
document.getElementById("btnExport").onclick = ()=>{
  if(!isAdmin()) return alert("Admin only");
  const rows = []; cards.forEach(c=> c.links.forEach(l=> rows.push({Card: c.name, Title: l.title, URL: l.url})));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Links"); XLSX.writeFile(wb, "DashboardCards.xlsx");
};

document.getElementById("btnImport").onclick = ()=>{
  if(!isAdmin()) return alert("Admin only");
  openModal(`<h3>Import (CSV/XLSX)</h3><div class="muted">Columns: Card, Title, URL</div><input id="fileImp" type="file" accept=".csv,.xlsx"><div style="margin-top:12px"><button id="doImp" class="btn btn-primary">Import</button></div>`);
  document.getElementById("doImp").onclick = ()=>{
    const f = document.getElementById("fileImp").files[0]; if(!f) return alert("Choose file");
    const r = new FileReader();
    r.onload = e=>{
      const wb = XLSX.read(e.target.result, {type:"binary"});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws);
      const map = {};
      rows.forEach(r=>{
        const cname = (r.Card||"").toString().trim();
        const title = (r.Title||"").toString().trim();
        const url = (r.URL||"").toString().trim();
        if(!cname || !title) return;
        if(!map[cname]) map[cname]=[];
        map[cname].push({id:uid(), title, url});
      });
      const newCards = [];
      Object.keys(map).forEach(name=>{
        let found = cards.find(c=>c.name.toLowerCase()===name.toLowerCase());
        if(found) newCards.push({id:found.id, name:found.name, icon:found.icon, links: map[name]});
        else newCards.push({id:uid(), name, icon:"ðŸ”—", links: map[name]});
      });
      cards = newCards; saveAll(); closeModal(); render(); alert("Import done");
    };
    r.readAsBinaryString(f);
  };
};

/* ------------------ Top Add Link (toolbar) ------------------ */
document.getElementById("btnAddLink").onclick = ()=>{
  if(!isAdmin()) return alert("Admin only");
  openModal(`<h3>Add Link</h3><select id="selCard">${cards.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('')}</select><input id="lTitle" placeholder="Title"><input id="lUrl" placeholder="https://example.com"><div style="margin-top:12px"><button id="saveLinkTop" class="btn btn-primary">Save</button></div>`);
  document.getElementById("saveLinkTop").onclick = ()=>{
    const cid = document.getElementById("selCard").value; const t = document.getElementById("lTitle").value.trim(); const u = document.getElementById("lUrl").value.trim();
    if(!t||!u) return alert("All fields required"); const c = cards.find(x=>x.id===cid); c.links.push({id:uid(),title:t,url:u}); saveAll(); closeModal(); render();
  };
};

/* ------------------ Delete modal ------------------ */
document.getElementById("btnDelete").onclick = ()=>{
  if(!isAdmin()) return alert("Admin only");
  openModal(`<h3>Delete</h3><label><input type="radio" name="del" value="card" checked> Card</label><br><label><input type="radio" name="del" value="link"> Link</label><div id="delWrap" style="margin-top:10px"><select id="delSel">${cards.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('')}</select></div><div style="margin-top:12px"><button id="doDel" class="btn btn-danger">Delete</button></div>`);
  document.querySelectorAll("input[name='del']").forEach(r=> r.onchange = ()=>{
    if(r.checked){
      if(r.value==="card"){ document.getElementById("delWrap").innerHTML = `<select id="delSel">${cards.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('')}</select>`; }
      else { const opts = cards.flatMap(c=> c.links.map(l=> `<option value="${c.id}__${l.id}">${escapeHtml(c.name)} â†’ ${escapeHtml(l.title)}</option>`)).join(''); document.getElementById("delWrap").innerHTML = `<select id="delSel">${opts}</select>`; }
    }
  });
  document.getElementById("doDel").onclick = ()=>{
    const v = document.getElementById("delSel").value;
    if(v.includes("__")){ const [cid,lid] = v.split("__"); const c = cards.find(x=>x.id===cid); c.links = c.links.filter(x=>x.id!==lid); }
    else { if(!confirm("Delete card and links?")) return; cards = cards.filter(x=>x.id!==v); }
    saveAll(); closeModal(); render();
  };
};

/* ------------------ Search ------------------ */
searchTop.addEventListener("input", ()=> render());

/* ------------------ Utils ------------------ */
function escapeHtml(s){ return (s||"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }

/* ------------------ Init ------------------ */
function init(){
  // wire toolbar button enabling toggles (ensures correct state immediately)
  updateToolbarState();

  // wire btnAddCard for toolbar
  document.getElementById("btnAddCard").onclick = ()=> {
    if(!isAdmin()) return alert("Admin only");
    openAddCard();
  };

  // wire btnSettings (already defined), btnExport/Import wired above
  render();
  if(isAdmin()) startWatcher();
}
init();

</script>
</body>
</html>
